#!/bin/bash
# Quick deploy - commit and push in one command
# Usage: ./deploy [commit-message]

set -e

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

# Get commit message from argument or use default
COMMIT_MSG="${1:-Auto-deploy: $(date +'%Y-%m-%d %H:%M')}"

echo -e "${BLUE}ğŸš€ Quick Deploy${NC}"
echo "==============="
echo ""

# Check for changes
if [ -z "$(git status --porcelain)" ]; then
    echo -e "${YELLOW}No uncommitted changes${NC}"
    
    # Check if we're ahead
    AHEAD=$(git rev-list --count origin/main..HEAD 2>/dev/null || echo "0")
    if [ "$AHEAD" -gt 0 ]; then
        echo -e "${GREEN}Found $AHEAD commit(s) ready to push${NC}"
        git log origin/main..HEAD --oneline
        echo ""
        read -p "Push to GitHub and deploy? (y/n) " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            git push origin main
            echo ""
            echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
            echo -e "${GREEN}âœ… Deployed!${NC}"
            echo ""
            echo "ğŸ“Š Monitor deployment:"
            echo "   https://github.com/hugh949/Gait-Analysis/actions"
            echo ""
            echo "â³ Takes 5-10 minutes"
            echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
        fi
    else
        echo -e "${GREEN}Everything up to date!${NC}"
    fi
    exit 0
fi

# Show changes
echo -e "${YELLOW}Changes to commit:${NC}"
git status --short
echo ""

# Commit
echo -e "${YELLOW}ğŸ“ Committing: $COMMIT_MSG${NC}"
git add -A
git commit -m "$COMMIT_MSG"
echo ""

# Push
echo -e "${YELLOW}ğŸ“¤ Pushing to GitHub...${NC}"
if git push origin main; then
    echo ""
    echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${GREEN}âœ… Deployment Started!${NC}"
    echo ""
    echo "ğŸ“Š Monitor deployment:"
    echo "   https://github.com/hugh949/Gait-Analysis/actions"
    echo ""
    echo "â³ Deployment typically takes 5-10 minutes"
    echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
else
    echo ""
    echo -e "${RED}âŒ Push failed!${NC}"
    echo "Try: git remote set-url origin git@github.com:hugh949/Gait-Analysis.git"
    exit 1
fi
